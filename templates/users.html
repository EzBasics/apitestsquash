<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile – Masonry Layout with Removable/Restorable Widgets</title>
  <!-- Load Chart.js from a CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --hero-bg: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --widget-bg: #fff;
    }
    html {
      font-size: 18px;
      scroll-behavior: smooth;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      color: #333;
      line-height: 1.5;
    }
    /* Navbar – reduced width and centered */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      padding: 3px 8px;
      border-radius: 8px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      width: 80%;
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      box-sizing: border-box;
    }
    .nav-container {
      display: flex;
      align-items: center;
      flex: 1;
    }
    .nav-container.left {
      justify-content: flex-start;
    }
    .nav-container.right {
      justify-content: flex-end;
    }
    .nav-search {
      width: 250px;
      height: 40px;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
      font-size: 1.2rem;
    }
    .nav-links {
      display: flex;
      align-items: center;
      list-style: none;
      gap: 15px;
      margin: 0;
      padding: 0;
    }
    .nav-links li {
      margin: 0 10px;
    }
    .nav-links li a {
      color: #333;
      font-family: system-ui, "Segoe UI", Helvetica, Arial, sans-serif,
        "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      font-size: 1.2rem;
      font-weight: 500;
      padding: 6px 0;
      text-decoration: none;
      position: relative;
      text-align: center;
    }
    .nav-links li a:before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 0%;
      background: #007BFF;
      border-radius: 12px;
      transition: all 0.4s ease;
    }
    .nav-links li a:hover:before {
      width: 100%;
    }
    .logo {
      flex: 0.15;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .logo img {
      width: 50px;  /* Increased logo size */
      transition: transform 0.3s ease;
    }
    .logo img:hover {
      transform: scale(1.2);
    }
    /* Container */
    .container {
      max-width: 1200px;
      margin: 120px auto 0;
      padding: 40px 15px;
    }
    h1, h2 {
      text-align: center;
      margin: 1rem 0;
    }
    /* Hero Section */
    .hero {
      background: var(--hero-bg);
      padding: 1.2rem 1rem;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .hero-card {
      background: var(--widget-bg);
      border-radius: 12px;
      width: 300px;      /* Wider profile card */
      height: 220px;
      margin: 0 auto;
      position: relative;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .profile-image-container {
      width: 70px;
      height: 70px;
      border-radius: 50%;           
      overflow: hidden;             
      border: 2px solid #fff;       
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: transparent;      
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    .profile-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-name {
      margin-top: 45px;
      font-size: 1.4rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .profile-location {
      font-size: 1rem;
      color: #666;
      margin: 0.3rem 0;
    }
    .profile-rating {
      font-size: 1rem;
      color: #333;
      font-weight: 600;
    }
    /* Controls – Edit Mode Toggle (Add Widget button hidden by default) */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 1rem 0;
    }
    .edit-mode-toggle {
      display: flex;
      align-items: center;
    }
    .edit-mode-toggle label {
      margin-right: 8px;
      font-weight: 600;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
      margin: 0 8px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: '';
      height: 22px; 
      width: 22px;
      left: 4px; 
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #4facfe;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #4facfe;
    }
    input:checked + .slider:before {
      transform: translateX(30px);
    }
    /* Hide Add Widget button by default */
    #addWidgetBtn {
      display: none;
      font-size: 1.2rem;
      padding: 10px 15px;
      cursor: pointer;
      background: #4facfe;
      color: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    /* Edit Controls Table */
    #widgetAddTable {
      display: none;
      margin: 1rem auto;
    }
    /* Table Containers */
    .table-container {
      max-height: 200px;
      overflow: hidden;
      padding-bottom: 40px;
      position: relative;
    }
    .view-more-btn {
      margin-top: 10px;
      cursor: pointer;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background-color: #4facfe;
      color: #fff;
      font-size: 0.9rem;
    }
    .view-more-btn:disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    /* Widget Grid */
    .widget-grid {
      display: flex;
      gap: 1rem;
      margin-top: 20px;
      margin-bottom: 2rem;
    }
    .widget-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 300px;
    }
    .drop-zone {
      display: none; /* Only shown in edit mode */
      border: 2px dashed #ccc;
      padding: 15px;
      text-align: center;
      color: #777;
      font-size: 1rem;
      min-height: 60px;
      transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
    }
    .drop-zone.drop-highlight {
      border-color: #007BFF;
      background-color: #e8f0fe;
      transform: scale(1.02);
    }
    .grid-item {
      background: var(--widget-bg);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
      padding: 8px;
      transition: transform 0.2s;
      position: relative;
      font-size: 0.8rem;
    }
    .grid-item.dragging {
      transform: scale(0.95);
      border: 2px solid green;
    }
    .grid-item.highlight {
      outline: 2px dashed #4facfe;
    }
    .remove-widget-btn {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.4rem;
      line-height: 28px;
      cursor: pointer;
      z-index: 2;
    }
    .grid-item.edit-mode-active .remove-widget-btn {
      display: block;
    }
    /* Ratings Widget */
    #ratingsWidget {
      font-size: 1.2rem;
    }
    #ratingsWidget h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    #currentRatingValue.big-rating {
      font-size: 2.3rem;
      font-weight: 700;
      margin: 0.3rem 0;
    }
    #highestRatingValue {
      font-size: 1.2rem;
      font-weight: 600;
      color: #666;
      margin: 0.3rem 0;
    }
    .chart-header {
      width: 100%;
      text-align: center;
      margin-bottom: 5px;
    }
    .chart-title-total {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 3px;
    }
    .legend {
      font-size: 0.85rem;
    }
    .donut-chart-wrapper {
      width: 180px;
      height: 180px;
      margin: 0 auto;
    }
    .affiliation-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .affiliation-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 8px;
      border-radius: 4px;
    }
    .affiliation-text {
      font-size: 1rem;
      color: #333;
    }
    .affiliations-container {
      max-height: 200px;
      overflow: hidden;
      padding-bottom: 30px;
    }
    #searchResults {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      width: 250px;
      display: none;
      z-index: 1001;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 4px;
      font-size: 1.2rem;
    }
    #searchResults div {
      display: flex;
      align-items: center;
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.3s;
    }
    #searchResults div:hover {
      background-color: #f0f0f0;
    }
    #searchResults img {
      width: 24px;
      height: 24px;
      margin-right: 8px;
      border-radius: 50%;
    }
    .rating-change-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      margin: 4px 0;
      border-radius: 8px;
      background: #f4f8fc;
      transition: background 0.3s ease;
      font-size: 0.9rem;
    }
    .rating-change-item:hover {
      background: #e0f7ff;
    }
    .rating-change-item .month {
      font-weight: 600;
    }
    .rating-change-item .diff {
      font-size: 1rem;
      font-weight: 600;
    }
    .yearly-change {
      display: inline-block;
      font-size: 1.1rem;
      font-weight: 700;
      color: #2f80ed;
      background: #f4f8fc;
      padding: 6px 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    /* Updated Table Styling */
    table.styled-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
      font-size: 0.95rem;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    table.styled-table thead tr {
      background-color: #4facfe;
      color: #fff;
      text-align: left;
      font-weight: bold;
    }
    table.styled-table thead tr th:first-child {
      text-align: center;
    }
    table.styled-table th, table.styled-table td {
      padding: 12px 16px;
    }
    table.styled-table tbody tr {
      border-bottom: 1px solid #ddd;
    }
    table.styled-table tbody tr:nth-of-type(even) {
      background-color: #f8f8f8;
    }
    table.styled-table tbody tr:hover {
      background-color: #e0f7ff;
    }
    table.styled-table tbody tr td:first-child {
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div class="navbar">
    <div class="nav-container left">
      <input id="navSearch" type="search" placeholder="Search..." class="nav-search">
      <ul class="nav-links">
        <li><a href="/">Roster</a></li>
        <li><a href="standings">Standings</a></li>
        <li><a href="compare">Compare</a></li>
      </ul>
    </div>
    <div class="logo">
      <a href="/"><img src="{{ url_for('static', filename='logo.png') }}" alt="Logo"></a>
    </div>
    <div class="nav-container right">
      <ul class="nav-links">
        <li><a href="live">Live</a></li>
        <li><a href="schedule">Schedule</a></li>
        <li><a href="allteamsschedule">Matchess</a></li>
      </ul>
    </div>
  </div>

  <!-- Search Results Dropdown -->
  <div id="searchResults"></div>

  <div class="container">
    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-card">
        <div class="profile-image-container">
          <img src="https://ussq-img-live.s3.us-east-1.amazonaws.com/uploads%2Fussq-profile-icon-default.png" alt="Profile Picture" class="profile-img">
        </div>
        <h2 class="profile-name" id="heroName">Name Here</h2>
        <p class="profile-location" id="heroLocation">Location Here</p>
        <p class="profile-rating" id="heroRating">Rating: --</p>
      </div>
    </section>
    
    <!-- Controls: Only show Add Widget button in edit mode -->
    <div class="controls">
      <div class="edit-mode-toggle">
        <label for="editModeToggle">Edit Mode</label>
        <label class="switch">
          <input type="checkbox" id="editModeToggle">
          <span class="slider"></span>
        </label>
      </div>
      <!-- Add Widget button is hidden by default -->
      <button id="addWidgetBtn">Add Widget</button>
    </div>
    
    <!-- Table for Re-Adding Removed Widgets (hidden unless opened) -->
    <table class="styled-table" id="widgetAddTable" style="display:none;">
      <thead>
        <tr>
          <th>Removed Widget</th>
          <th style="text-align: center;">Restore</th>
        </tr>
      </thead>
      <tbody id="widgetAddTableBody"></tbody>
    </table>
    
    <!-- Widget Grid -->
    <div id="widgetGrid" class="widget-grid">
      <!-- Left Column -->
      <div id="leftColumn" class="widget-column">
        <!-- Ratings Widget (always shown) -->
        <div class="grid-item" id="ratingsWidget">
          <button class="remove-widget-btn">×</button>
          <h3>RATINGS</h3>
          <div>
            <div id="currentRatingValue" class="big-rating">--</div>
            <div>Universal Squash Rating</div>
          </div>
          <div>
            <div id="highestRatingValue">--</div>
            <div>Highest <span id="highestRatingDateValue">--</span></div>
          </div>
        </div>
        
        <!-- Singles Wins Widget -->
        <div class="grid-item" id="Single Wins">
          <button class="remove-widget-btn">×</button>
          <div id="singlesWinsChart-header" class="chart-header">
            <div class="chart-title-total"></div>
            <div id="singlesWinsChart-legend" class="legend"></div>
          </div>
          <div class="donut-chart-wrapper">
            <canvas id="singlesWinsChart" class="donut-chart"></canvas>
          </div>
        </div>
        
        <!-- Doubles Wins Widget (if data available) -->
        <div class="grid-item" id="doublesWinsBox">
          <button class="remove-widget-btn">×</button>
          <div id="doublesWinsChart-header" class="chart-header">
            <div class="chart-title-total"></div>
            <div id="doublesWinsChart-legend" class="legend"></div>
          </div>
          <div class="donut-chart-wrapper">
            <canvas id="doublesWinsChart" class="donut-chart"></canvas>
          </div>
        </div>
        
        <!-- Leagues Widget (if data available) -->
        <div class="grid-item" id="leaguesWidget">
          <button class="remove-widget-btn">×</button>
          <h3>Leagues</h3>
          <div id="leaguesList"></div>
        </div>
        
        <!-- Schools Widget (if data available) -->
        <div class="grid-item" id="schoolsWidget">
          <button class="remove-widget-btn">×</button>
          <h3>Schools</h3>
          <div id="schoolsContent"></div>
        </div>
        
        <!-- Left Column Drop Zone (only in edit mode) -->
        <div class="drop-zone" data-column="left">Drop widget here</div>
      </div>
      
      <!-- Right Column -->
      <div id="rightColumn" class="widget-column">
        <!-- Ratings History Chart Widget -->
        <div class="grid-item" id="ratingsHistoryCard">
          <button class="remove-widget-btn">×</button>
          <h3>Ratings History Chart</h3>
          <canvas id="ratingsHistoryChart"></canvas>
        </div>
        
        <!-- Singles Losses Widget (if data available) -->
        <div class="grid-item" id="singlesLossesBox">
          <button class="remove-widget-btn">×</button>
          <div id="singlesLossesChart-header" class="chart-header">
            <div class="chart-title-total"></div>
            <div id="singlesLossesChart-legend" class="legend"></div>
          </div>
          <div class="donut-chart-wrapper">
            <canvas id="singlesLossesChart" class="donut-chart"></canvas>
          </div>
        </div>
        
        <!-- Doubles Losses Widget (if data available) -->
        <div class="grid-item" id="doublesLossesBox">
          <button class="remove-widget-btn">×</button>
          <div id="doublesLossesChart-header" class="chart-header">
            <div class="chart-title-total"></div>
            <div id="doublesLossesChart-legend" class="legend"></div>
          </div>
          <div class="donut-chart-wrapper">
            <canvas id="doublesLossesChart" class="donut-chart"></canvas>
          </div>
        </div>
        
        <!-- Affiliations Widget (if data available) -->
        <div class="grid-item" id="affiliationsWidget">
          <button class="remove-widget-btn">×</button>
          <h3>Affiliations</h3>
          <div id="affiliationsListContainer" class="affiliations-container"></div>
        </div>
        
        <!-- Monthly Rating Change Widget (if data available) -->
        <div class="grid-item" id="ratingChangeWidget">
          <button class="remove-widget-btn">×</button>
          <h3>Monthly Rating Change</h3>
          <div id="yearlyRatingChange" class="yearly-change"></div>
          <div id="ratingChangeList"></div>
        </div>
        
        <!-- Right Column Drop Zone (only in edit mode) -->
        <div class="drop-zone" data-column="right">Drop widget here</div>
      </div>
    </div>
  </div>
  
  <script>
    /* === Helper to format ratings === */
    function formatRating(num) {
      let n = parseFloat(num).toFixed(2);
      return n.endsWith("0") ? parseFloat(num).toFixed(1) : n;
    }
    
    /* === Update URL with user_id for state persistence === */
    function updateURLWithUser(userId) {
      history.pushState(null, '', '?user_id=' + userId);
    }
    
    /* === Global Variables === */
    let removedWidgets = [];
    let editMode = false;
    let draggingItem = null;
    let candidateWidget = null;
    let candidateDropZone = null;
    let currentUserId = 328331;
    
    const editModeToggle = document.getElementById('editModeToggle');
    const addWidgetBtn = document.getElementById('addWidgetBtn');
    const widgetAddTable = document.getElementById('widgetAddTable');
    const widgetAddTableBody = document.getElementById('widgetAddTableBody');
    
    /* === Toggle Edit Mode === */
    editModeToggle.addEventListener('change', (e) => {
      editMode = e.target.checked;
      // Toggle display of the Add Widget button based on edit mode
      addWidgetBtn.style.display = editMode ? 'inline-block' : 'none';
      // Toggle drop zone visibility based on edit mode
      document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.style.display = editMode ? 'block' : 'none';
      });
      if (editMode) {
        document.querySelectorAll('.view-more-btn').forEach(btn => { btn.disabled = true; });
      } else {
        document.querySelectorAll('.view-more-btn').forEach(btn => { btn.disabled = false; });
      }
      if (!editMode) widgetAddTable.style.display = 'none';
      document.querySelectorAll('.grid-item').forEach(item => {
        if (editMode) {
          item.classList.add('edit-mode-active');
          item.addEventListener('mousedown', dragStart);
          const removeBtn = item.querySelector('.remove-widget-btn');
          if (removeBtn) removeBtn.addEventListener('click', removeWidget);
        } else {
          item.classList.remove('edit-mode-active');
          item.removeEventListener('mousedown', dragStart);
          const removeBtn = item.querySelector('.remove-widget-btn');
          if (removeBtn) removeBtn.removeEventListener('click', removeWidget);
        }
      });
    });
    
    /* === Toggle Add Widget Button === */
    addWidgetBtn.addEventListener('click', () => {
      const currentDisplay = getComputedStyle(widgetAddTable).display;
      widgetAddTable.style.display = (currentDisplay === 'none' ? 'table' : 'none');
      updateRemovedWidgetsTable();
      if (document.getElementById('ratingsHistoryCard')) updateRatingsHistoryChart(currentUserId);
    });
    
    /* === Remove Widget === */
    function removeWidget(e) {
      e.stopPropagation();
      const widget = this.parentElement;
      const widgetName = widget.querySelector('h3') ? widget.querySelector('h3').textContent.trim() : widget.id;
      removedWidgets.push({ id: widget.id, element: widget, name: widgetName });
      widget.remove();
      updateRemovedWidgetsTable();
      if (widget.id === "ratingsHistoryCard") updateRatingsHistoryChart(currentUserId);
    }
    
    function updateRemovedWidgetsTable() {
      widgetAddTableBody.innerHTML = '';
      if (removedWidgets.length === 0) {
        widgetAddTable.style.display = 'none';
        return;
      }
      removedWidgets.forEach((w, index) => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = w.name;
        const tdAdd = document.createElement('td');
        tdAdd.style.textAlign = 'center';
        const addBtn = document.createElement('button');
        addBtn.textContent = 'Restore';
        addBtn.style.cursor = 'pointer';
        addBtn.addEventListener('click', () => {
          document.getElementById('leftColumn').insertBefore(w.element, document.querySelector('#leftColumn .drop-zone'));
          removedWidgets.splice(index, 1);
          if (editMode) {
            w.element.classList.add('edit-mode-active');
            w.element.addEventListener('mousedown', dragStart);
            const removeBtn = w.element.querySelector('.remove-widget-btn');
            if (removeBtn) removeBtn.addEventListener('click', removeWidget);
          }
          updateRemovedWidgetsTable();
          if (w.element.id === "ratingsHistoryCard") updateRatingsHistoryChart(currentUserId);
        });
        tdAdd.appendChild(addBtn);
        tr.appendChild(tdName);
        tr.appendChild(tdAdd);
        widgetAddTableBody.appendChild(tr);
      });
      widgetAddTable.style.display = 'table';
    }
    
    /* === Drag & Drop Logic === */
    function dragStart(e) {
      if (e.button !== 0) return;
      e.preventDefault();
      draggingItem = e.currentTarget;
      draggingItem.classList.add('dragging');
      document.addEventListener('mousemove', dragMove);
      document.addEventListener('mouseup', dragEnd);
    }
    
    function dragMove(e) {
      candidateWidget = null;
      candidateDropZone = null;
      document.querySelectorAll('.grid-item').forEach(item => {
        if (item === draggingItem) return;
        const rect = item.getBoundingClientRect();
        if (e.clientX >= rect.left && e.clientX <= rect.right &&
            e.clientY >= rect.top && e.clientY <= rect.bottom) {
          candidateWidget = item;
          item.classList.add('highlight');
        } else {
          item.classList.remove('highlight');
        }
      });
      document.querySelectorAll('.drop-zone').forEach(zone => {
        const rect = zone.getBoundingClientRect();
        if (e.clientX >= rect.left && e.clientX <= rect.right &&
            e.clientY >= rect.top && e.clientY <= rect.bottom) {
          candidateDropZone = zone;
          zone.classList.add('drop-highlight');
        } else {
          zone.classList.remove('drop-highlight');
        }
      });
      const scrollThreshold = 50, scrollSpeed = 20;
      if (e.clientY < scrollThreshold) window.scrollBy({ top: -scrollSpeed, behavior: 'smooth' });
      else if (e.clientY > window.innerHeight - scrollThreshold) window.scrollBy({ top: scrollSpeed, behavior: 'smooth' });
    }
    
    function dragEnd(e) {
      document.removeEventListener('mousemove', dragMove);
      document.removeEventListener('mouseup', dragEnd);
      document.querySelectorAll('.grid-item').forEach(item => item.classList.remove('highlight'));
      document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drop-highlight'));
      if (candidateWidget && candidateWidget !== draggingItem) {
        swapNodes(draggingItem, candidateWidget);
      } else if (candidateDropZone) {
        candidateDropZone.parentElement.insertBefore(draggingItem, candidateDropZone);
      }
      if (window.ratingsHistoryChart && typeof window.ratingsHistoryChart.destroy === 'function') {
        window.ratingsHistoryChart.destroy();
      }
      draggingItem.classList.remove('dragging');
      if (document.getElementById('ratingsHistoryCard')) updateRatingsHistoryChart(currentUserId);
      draggingItem = candidateWidget = candidateDropZone = null;
    }
    
    function swapNodes(a, b) {
      const aParent = a.parentNode, bParent = b.parentNode;
      const aNext = a.nextSibling, bNext = b.nextSibling;
      if (aNext === b) aParent.insertBefore(b, a);
      else if (bNext === a) bParent.insertBefore(a, b);
      else {
        aParent.insertBefore(b, aNext);
        bParent.insertBefore(a, bNext);
      }
    }
    
    /* === Dynamic User Widgets === */
    function updateUserWidgets(userId, searchLocation) {
      currentUserId = userId;
      updateURLWithUser(userId);
      // Update hero card
      fetch(`/proxy/user/${userId}`)
        .then(res => res.json())
        .then(userData => {
          document.getElementById('heroName').textContent = userData.name;
          if (searchLocation) {
            document.getElementById('heroLocation').textContent = searchLocation;
          } else if (userData.mainAffiliation) {
            const loc = (userData.mainAffiliation.shortName || '') + (userData.mainAffiliation.City ? ', ' + userData.mainAffiliation.City : '');
            document.getElementById('heroLocation').textContent = loc;
          }
          let ratingVal = userData.rating || userData.Intercom_Rating;
          ratingVal = ratingVal ? formatRating(ratingVal) : '--';
          document.getElementById('heroRating').textContent = 'Rating: ' + ratingVal;
        })
        .catch(err => console.error('Error fetching user profile:', err));
      
      fetch(`/proxy/user/${userId}/ratings`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            const ratingVal = formatRating(data[0].rating);
            document.getElementById('currentRatingValue').textContent = ratingVal;
            document.getElementById('heroRating').textContent = 'Rating: ' + ratingVal;
          }
        })
        .catch(err => console.error('Error fetching current rating:', err));
      
      fetch(`/proxy/user/${userId}/ratings-top`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            document.getElementById('highestRatingValue').textContent = formatRating(data[0].rating);
            const topDate = new Date(data[0].ratingPeriod);
            document.getElementById('highestRatingDateValue').textContent = topDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
          }
        })
        .catch(err => console.error('Error fetching highest rating:', err));
      
      fetch(`/proxy/user/${userId}/affiliations`)
        .then(res => res.json())
        .then(data => {
          const affWidget = document.getElementById('affiliationsWidget');
          const container = document.getElementById('affiliationsListContainer');
          container.innerHTML = "";
          if (!data || data.length === 0) {
            affWidget.style.display = 'none';
          } else {
            affWidget.style.display = '';
            data.forEach(affiliation => {
              const item = document.createElement('div');
              item.classList.add('affiliation-item');
              if (affiliation.logoImageUrl) {
                const logo = document.createElement('img');
                logo.src = affiliation.logoImageUrl;
                logo.alt = affiliation.descr || 'Affiliation logo';
                logo.classList.add('affiliation-logo');
                item.appendChild(logo);
              }
              const span = document.createElement('span');
              span.classList.add('affiliation-text');
              span.textContent = affiliation.descr;
              item.appendChild(span);
              container.appendChild(item);
            });
            if (container.children.length > 3 && !editMode) {
              if (!document.getElementById('affViewMoreBtn')) {
                const viewMoreBtn = document.createElement('button');
                viewMoreBtn.id = 'affViewMoreBtn';
                viewMoreBtn.className = 'view-more-btn';
                viewMoreBtn.textContent = 'View More';
                viewMoreBtn.addEventListener('click', () => {
                  if (editMode) return;
                  if (container.style.maxHeight === 'none') {
                    container.style.maxHeight = '200px';
                    viewMoreBtn.textContent = 'View More';
                  } else {
                    container.style.maxHeight = 'none';
                    viewMoreBtn.textContent = 'View Less';
                  }
                });
                affWidget.appendChild(viewMoreBtn);
              }
              container.style.maxHeight = '200px';
            }
          }
        })
        .catch(err => console.error('Error fetching affiliations:', err));
      
      updateLeaguesWidget(userId);
      updateSchoolsWidget(userId);
      updateRatingsHistoryChart(userId);
      updateMonthlyRatingChangeWidget(userId);
    }
    
    function updateLeaguesWidget(userId) {
      fetch(`/proxy/players/${userId}/leagues`)
        .then(res => res.json())
        .then(data => {
          const widget = document.getElementById('leaguesWidget');
          const leaguesList = document.getElementById('leaguesList');
          leaguesList.innerHTML = "";
          const table = document.createElement('table');
          table.classList.add('styled-table');
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          ['Team', 'League', 'Start Date', 'End Date'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          if (data && data.length > 0) {
            const sorted = data.sort((a, b) => new Date(b.StartDate) - new Date(a.StartDate));
            sorted.forEach(league => {
              const tr = document.createElement('tr');
              const teamTd = document.createElement('td');
              teamTd.textContent = league.Teamname;
              const leagueTd = document.createElement('td');
              leagueTd.textContent = league.LeagueDescr;
              const startTd = document.createElement('td');
              const startDate = new Date(league.StartDate.substring(0,10));
              startTd.textContent = startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
              const endTd = document.createElement('td');
              const endDate = new Date(league.EndDate.substring(0,10));
              endTd.textContent = endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
              tr.appendChild(teamTd);
              tr.appendChild(leagueTd);
              tr.appendChild(startTd);
              tr.appendChild(endTd);
              tbody.appendChild(tr);
            });
          } else {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 4;
            td.textContent = "No data available";
            tr.appendChild(td);
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          const container = document.createElement('div');
          container.className = 'table-container';
          container.appendChild(table);
          leaguesList.appendChild(container);
          if (table.tBodies[0].rows.length > 4 && !editMode) {
            const viewMoreBtn = document.createElement('button');
            viewMoreBtn.className = 'view-more-btn';
            viewMoreBtn.textContent = 'View More';
            viewMoreBtn.addEventListener('click', () => {
              if (editMode) return;
              if (container.style.maxHeight === 'none') {
                container.style.maxHeight = '200px';
                viewMoreBtn.textContent = 'View More';
              } else {
                container.style.maxHeight = 'none';
                viewMoreBtn.textContent = 'View Less';
              }
            });
            leaguesList.appendChild(viewMoreBtn);
          }
        })
        .catch(err => console.error('Error fetching leagues:', err));
    }
    
    function updateSchoolsWidget(userId) {
      fetch(`/proxy/user/${userId}/schools`)
        .then(res => res.json())
        .then(data => {
          const widget = document.getElementById('schoolsWidget');
          widget.innerHTML = "";
          const header = document.createElement('h3');
          header.textContent = 'Schools';
          widget.appendChild(header);
          const tableContainer = document.createElement('div');
          tableContainer.className = 'table-container';
          const table = document.createElement('table');
          table.classList.add('styled-table');
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          ['School', 'Grad Year', 'Team Captain'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          if (data && data.length > 0) {
            data.forEach(school => {
              const tr = document.createElement('tr');
              const tdDescr = document.createElement('td');
              tdDescr.textContent = school.Descr || school.Level || '';
              const tdGradYear = document.createElement('td');
              tdGradYear.textContent = school.GradYear;
              const tdTeamCaptain = document.createElement('td');
              tdTeamCaptain.textContent = school.TeamCaptain;
              tr.appendChild(tdDescr);
              tr.appendChild(tdGradYear);
              tr.appendChild(tdTeamCaptain);
              tbody.appendChild(tr);
            });
          } else {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 3;
            td.textContent = "No data available";
            tr.appendChild(td);
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          tableContainer.appendChild(table);
          widget.appendChild(tableContainer);
          if (table.tBodies[0].rows.length > 4 && !editMode) {
            const viewMoreBtn = document.createElement('button');
            viewMoreBtn.className = 'view-more-btn';
            viewMoreBtn.textContent = 'View More';
            viewMoreBtn.addEventListener('click', () => {
              if (editMode) return;
              if (tableContainer.style.maxHeight === 'none') {
                tableContainer.style.maxHeight = '200px';
                viewMoreBtn.textContent = 'View More';
              } else {
                tableContainer.style.maxHeight = 'none';
                viewMoreBtn.textContent = 'View Less';
              }
            });
            widget.appendChild(viewMoreBtn);
          }
        })
        .catch(err => console.error('Error fetching schools:', err));
    }
    
    function updateRatingsHistoryChart(userId) {
      fetch(`/proxy/user/${userId}/ratings_history`)
        .then(res => res.json())
        .then(data => {
          // Filter to only "Singles International Rating"
          const filtered = data.filter(entry => entry.RatingGroup === "Singles International Rating");
          const widget = document.getElementById('ratingsHistoryCard');
          if (!filtered || filtered.length === 0) {
            widget.style.display = 'none';
            return;
          } else {
            widget.style.display = '';
          }
          const labels = filtered.map(entry => {
            const date = new Date(entry.RankingPeriod);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }).reverse();
          const ratings = filtered.map(entry => entry.NewRating).reverse();
          const ctx = document.getElementById('ratingsHistoryChart').getContext('2d');
          if (window.ratingsHistoryChart && typeof window.ratingsHistoryChart.destroy === 'function') {
            window.ratingsHistoryChart.destroy();
          }
          window.ratingsHistoryChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Rating',
                data: ratings,
                borderColor: '#4facfe',
                backgroundColor: 'rgba(79, 172, 254, 0.3)',
                fill: true,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 5
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              scales: {
                x: { title: { display: true, text: 'Date' } },
                y: { title: { display: true, text: 'Rating' } }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: '#fff',
                  titleColor: '#333',
                  bodyColor: '#666',
                  borderColor: '#ddd',
                  borderWidth: 1,
                  padding: 8
                }
              }
            }
          });
        })
        .catch(err => console.error('Error fetching ratings history:', err));
    }
    
    function updateMonthlyRatingChangeWidget(userId) {
      fetch(`/proxy/user/${userId}/ratings_history`)
        .then(res => res.json())
        .then(data => {
          // Filter to only include Singles International Rating
          data = data.filter(entry => entry.RatingGroup === "Singles International Rating");
          
          if (!data || data.length === 0) {
            document.getElementById('ratingChangeWidget').style.display = 'none';
            return;
          } else {
            document.getElementById('ratingChangeWidget').style.display = '';
          }
          data.sort((a, b) => new Date(a.RankingPeriod) - new Date(b.RankingPeriod));
          let html = '';
          let yearlyChange = 0;
          const oneYearAgo = new Date();
          oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
          for (let i = 1; i < data.length; i++) {
            const prev = data[i-1], curr = data[i];
            let diff = curr.NewRating - prev.NewRating;
            // Skip clearly wrong differences (e.g., > 20 points)
            if (Math.abs(diff) > 20) continue;
            diff = parseFloat(diff.toFixed(2));
            if (new Date(curr.RankingPeriod) >= oneYearAgo) yearlyChange += diff;
            const month = new Date(curr.RankingPeriod).toLocaleString('en-US', { month: 'short' });
            const color = diff > 0 ? '#2f80ed' : diff < 0 ? '#1c64a0' : '#333';
            const sign = diff > 0 ? '+' : '';
            html += `<div class="rating-change-item"><span class="month">${month}</span><span class="diff" style="color: ${color};">${sign}${diff}</span></div>`;
          }
          document.getElementById('yearlyRatingChange').textContent = 'Past Year Change: ' + (yearlyChange > 0 ? '+' : '') + yearlyChange.toFixed(2);
          document.getElementById('ratingChangeList').innerHTML = html;
        })
        .catch(err => console.error('Error fetching monthly rating change:', err));
    }
    
    /* === Search Functionality === */
    const searchInput = document.getElementById('navSearch');
    const searchResultsDiv = document.getElementById('searchResults');
    
    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }
    
    const performSearchDebounced = debounce(performSearch, 300);
    searchInput.addEventListener('input', performSearchDebounced);
    
    function performSearch() {
      const query = searchInput.value.trim();
      if (!query) {
        searchResultsDiv.style.display = "none";
        searchResultsDiv.innerHTML = "";
        return;
      }
      fetch(`/proxy/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          searchResultsDiv.innerHTML = "";
          const players = data.filter(item => item.ObjectType === "Player");
          if (!players || players.length === 0) { 
            searchResultsDiv.style.display = "none"; 
            return; 
          }
          players.forEach(item => {
            const div = document.createElement('div');
            let imgHTML = "";
            if (item.LogoImageUrl) {
              imgHTML = `<img src="${item.LogoImageUrl}" alt="${item.ObjectName}">`;
            }
            const locText = item.ObjectLocation ? ` - ${item.ObjectLocation}` : "";
            div.innerHTML = `${imgHTML}<span>${item.ObjectName}${locText}</span>`;
            div.addEventListener('click', () => {
              updateUserWidgets(item.ObjectId, item.ObjectLocation);
              searchResultsDiv.style.display = "none";
              searchResultsDiv.innerHTML = "";
              searchInput.value = "";
            });
            searchResultsDiv.appendChild(div);
          });
          const rect = searchInput.getBoundingClientRect();
          searchResultsDiv.style.top = (rect.bottom + window.scrollY) + "px";
          searchResultsDiv.style.left = (rect.left + window.scrollX) + "px";
          searchResultsDiv.style.width = rect.width + "px";
          searchResultsDiv.style.display = "block";
        })
        .catch(err => console.error('Error during search:', err));
    }
    
    /* === Chart.js and Donut Chart Functions === */
    function updateTotal(chart) {
      const total = chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
      const headerEl = document.getElementById(chart.canvas.id + '-header');
      if (headerEl) {
        const titleEl = headerEl.querySelector('.chart-title-total');
        if (titleEl) titleEl.textContent = chart._chartTitle + ' - ' + total;
      }
    }
    
    function toggleSegment(chart, index) {
      if (!chart._hidden) chart._hidden = [];
      if (chart._hidden[index]) {
        chart.data.datasets[0].data[index] = chart._originalData[index];
        chart._hidden[index] = false;
      } else {
        chart.data.datasets[0].data[index] = 0;
        chart._hidden[index] = true;
      }
      chart.update();
      renderLegend(chart, chart.canvas.id + '-legend');
      updateTotal(chart);
    }
    
    function renderLegend(chart, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      chart.data.labels.forEach((label, index) => {
        if (chart._originalData[index] <= 0) return;
        const legendItem = document.createElement('div');
        legendItem.style.display = 'inline-block';
        legendItem.style.marginRight = '10px';
        legendItem.style.cursor = 'pointer';
        const swatch = document.createElement('span');
        swatch.style.display = 'inline-block';
        swatch.style.width = '8px';
        swatch.style.height = '8px';
        swatch.style.backgroundColor = chart._originalColors[index];
        swatch.style.marginRight = '5px';
        if (chart._hidden && chart._hidden[index]) swatch.style.opacity = '0.3';
        legendItem.appendChild(swatch);
        const text = document.createElement('span');
        text.textContent = label + ' (' + chart._originalData[index] + ')';
        legendItem.appendChild(text);
        legendItem.addEventListener('click', () => { toggleSegment(chart, index); });
        container.appendChild(legendItem);
      });
    }
    
    const fixedColors = ['#4facfe', '#2f80ed', '#1c64a0'];
    
    function createStyledDoughnutChart(canvasId, dataValues, titleText, colors) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['3-game match', '4-game match', '5-game match'],
          datasets: [{
            data: dataValues,
            backgroundColor: colors,
            hoverOffset: 0,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            title: { display: false },
            tooltip: {
              backgroundColor: '#fff',
              titleColor: '#333',
              bodyColor: '#666',
              borderColor: '#ddd',
              borderWidth: 1,
              padding: 8
            }
          }
        }
      });
      chart._originalData = dataValues.slice();
      chart._hidden = [false, false, false];
      chart._originalColors = colors;
      chart._chartTitle = titleText;
      renderLegend(chart, canvasId + '-legend');
      updateTotal(chart);
      return chart;
    }
    
    /* === Initial Fetch Calls Using Default currentUserId === */
    fetch(`/proxy/user/${currentUserId}/record`)
      .then(res => res.json())
      .then(data => {
        let singlesWins = {3:0,4:0,5:0}, singlesLosses = {3:0,4:0,5:0},
            doublesWins = {3:0,4:0,5:0}, doublesLosses = {3:0,4:0,5:0};
        if (data && data.length > 0) {
          data.forEach(item => {
            if (item.type === 'S') {
              singlesWins[item.matchesType] += item.matchesWon;
              singlesLosses[item.matchesType] += item.matchesLost;
            } else if (item.type === 'D') {
              doublesWins[item.matchesType] += item.matchesWon;
              doublesLosses[item.matchesType] += item.matchesLost;
            }
          });
        }
        createStyledDoughnutChart('singlesWinsChart', [singlesWins[3], singlesWins[4], singlesWins[5]], 'Singles Wins', fixedColors);
        createStyledDoughnutChart('singlesLossesChart', [singlesLosses[3], singlesLosses[4], singlesLosses[5]], 'Singles Losses', fixedColors);
        if ((doublesWins[3] + doublesWins[4] + doublesWins[5]) > 0) {
          createStyledDoughnutChart('doublesWinsChart', [doublesWins[3], doublesWins[4], doublesWins[5]], 'Doubles Wins', fixedColors);
        } else {
          document.getElementById('doublesWinsBox').style.display = 'none';
        }
        if ((doublesLosses[3] + doublesLosses[4] + doublesLosses[5]) > 0) {
          createStyledDoughnutChart('doublesLossesChart', [doublesLosses[3], doublesLosses[4], doublesLosses[5]], 'Doubles Losses', fixedColors);
        } else {
          document.getElementById('doublesLossesBox').style.display = 'none';
        }
      })
      .catch(err => console.error('Error fetching user record:', err));
      
    /* === On Page Load: Check for URL parameter "user_id" === */
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const userIdParam = params.get('user_id');
      if (userIdParam) {
        currentUserId = parseInt(userIdParam);
        updateUserWidgets(currentUserId);
      }
    });
  </script>
</body>
</html>
